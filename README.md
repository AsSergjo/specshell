# Spectrogram Context Menu - Shell Extension для Windows

Расширение контекстного меню Windows 11/10, которое добавляет пункт "Показать спектрограмму" для аудиофайлов.

## Возможности

- ✅ Интеграция в контекстное меню Проводника Windows
- ✅ Автоматическая генерация спектрограммы с помощью FFmpeg
- ✅ Использование стандартного просмотрщика изображений Windows
- ✅ Поддержка множества аудиоформатов
- ✅ Чистый WinAPI без внешних библиотек
- ✅ Создание изображения во временной папке системы

## Скриншот

![Скриншот работы расширения](Image_result.jpg)

## Поддерживаемые форматы

- MP3, FLAC, WAV, OGG, M4A
- AAC, WMA, OPUS, APE, AC3

## Требования

### Для компиляции:
- **Visual Studio 2019/2022** (рекомендуется) ИЛИ **MinGW-w64**
- Windows SDK
- C++11 или выше

### Для работы:
- Windows 10/11
- FFmpeg.exe в PATH

## Компиляция

### Вариант 1: Visual Studio (с `build.bat`)

Этот способ является самым простым и рекомендованным.

1. Откройте **Developer Command Prompt for VS 2022** (или VS 2019).
2. Перейдите в папку с исходниками:
   ```
   cd путь\к\исходникам
   ```
3. Запустите компиляцию:
   ```
   build.bat
   ```
   DLL-файл (`SpectrogramContextMenu.dll`) будет создан в корневой папке проекта.

### Вариант 2: CMake

Этот способ предоставляет больше гибкости и позволяет использовать разные IDE и компиляторы.

1. Убедитесь, что у вас установлен CMake.
2. Создайте папку для сборки и перейдите в нее:
   ```
   mkdir build
   cd build
   ```
3. Сгенерируйте файлы проекта (например, для Visual Studio 2022 x64):
   ```
   cmake .. -G "Visual Studio 17 2022" -A x64
   ```
4. Скомпилируйте проект:
   ```
   cmake --build . --config Release
   ```
   DLL-файл (`SpectrogramContextMenu.dll`) будет находиться в папке `build\Release`.

## Установка

После успешной компиляции:

1. **Откройте командную строку от имени Администратора**
2. Перейдите в папку с скомпилированной DLL
3. Зарегистрируйте DLL:
   ```
   regsvr32 SpectrogramContextMenu.dll
   ```
4. Должно появиться сообщение об успешной регистрации

## Использование

1. Найдите любой аудиофайл в Проводнике Windows
2. Кликните правой кнопкой мыши на файле
3. В контекстном меню выберите **"Показать спектрограмму"**
4. Подождите несколько секунд (зависит от размера файла)
5. Спектрограмма откроется в стандартном просмотрщике изображений Windows

## Удаление

1. **Откройте командную строку от имени Администратора**
2. Перейдите в папку с DLL
3. Отмените регистрацию:
   ```
   regsvr32 /u SpectrogramContextMenu.dll
   ```

## Структура проекта

```
SpectrogramContextMenu.h    - Заголовочный файл с объявлениями классов
SpectrogramContextMenu.cpp  - Реализация Shell Extension
Register.cpp                - Функции регистрации/удаления COM сервера
SpectrogramContextMenu.def  - Файл экспорта функций DLL
build.bat                   - Скрипт компиляции для Visual Studio
README.md                   - Этот файл
```

## Технические детали

### Архитектура

Проект реализует COM интерфейсы для создания Shell Extension:
- **IShellExtInit** - инициализация расширения и получение выбранных файлов
- **IContextMenu** - добавление пункта в контекстное меню и обработка команд
- **IClassFactory** - фабрика для создания экземпляров COM объектов

### Процесс работы

1. Windows Explorer вызывает `IShellExtInit::Initialize()` при клике правой кнопкой
2. Расширение проверяет, является ли файл аудио по расширению
3. `IContextMenu::QueryContextMenu()` добавляет пункт "Показать спектрограмму"
4. При выборе пункта вызывается `IContextMenu::InvokeCommand()`
5. Запускается FFmpeg с параметрами для генерации спектрограммы:
   ```
   ffmpeg -i "input.flac" -lavfi "showspectrumpic=s=1024x720:mode=combined:color=fire:scale=log" "spec.png"
   ```
6. Созданное изображение открывается через `ShellExecuteW()`

### Параметры спектрограммы

- **Размер**: 1024x720 пикселей
- **Режим**: combined (вертикальная ориентация)
- **Цветовая схема**: fire
- **Шкала**: логарифмическая (log)
- **Выходной файл**: `%TEMP%\spec.png`

### Регистрация в реестре

DLL регистрируется для каждого поддерживаемого расширения в:
```
HKEY_CLASSES_ROOT\.mp3\shellex\ContextMenuHandlers\SpectrogramMenu
HKEY_CLASSES_ROOT\.flac\shellex\ContextMenuHandlers\SpectrogramMenu
...
```

## Решение проблем

### "FFmpeg не найден"
- Убедитесь, что FFmpeg установлен
- Добавьте путь к ffmpeg.exe в системную переменную PATH
- Или поместите ffmpeg.exe в одну из стандартных директорий

### "Не удалось создать спектрограмму"
- Проверьте, что файл не поврежден
- Убедитесь, что формат поддерживается FFmpeg
- Проверьте права доступа к временной папке

### Пункт меню не появляется
- Убедитесь, что DLL зарегистрирована (от имени администратора)
- Перезапустите Explorer.exe:
  ```
  taskkill /f /im explorer.exe
  start explorer.exe
  ```
- Проверьте, что файл имеет поддерживаемое расширение

### Ошибки компиляции
- Убедитесь, что используете Developer Command Prompt для Visual Studio
- Проверьте наличие Windows SDK

## Безопасность

- DLL работает в контексте процесса Explorer.exe
- Используется минимальный набор привилегий
- Временные файлы создаются в системной временной папке
- FFmpeg запускается как отдельный процесс с ограниченным временем ожидания

## Лицензия

Этот проект лицензирован на условиях лицензии MIT - см. файл [LICENSE](LICENSE) для получения подробной информации.

## Автор

Создано с использованием чистого WinAPI для максимальной производительности и минимальных зависимостей.
